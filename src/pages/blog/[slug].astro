---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts
    .filter(post => !post.data.draft)
    .map((post) => ({
      params: { slug: post.slug },
      props: { post },
    }));
}

const { post } = Astro.props;
const { Content } = await post.render();

// Get related posts (same tags)
const allPosts = await getCollection('blog');
const relatedPosts = allPosts
  .filter(p => !p.data.draft && p.slug !== post.slug)
  .filter(p => p.data.tags.some(tag => post.data.tags.includes(tag)))
  .slice(0, 3);

// Schema.org Article structured data
const articleSchema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": post.data.title,
  "description": post.data.description,
  "image": post.data.image || "/og-image.jpg",
  "datePublished": post.data.pubDate.toISOString(),
  "dateModified": (post.data.updatedDate || post.data.pubDate).toISOString(),
  "author": {
    "@type": "Person",
    "name": post.data.author
  },
  "publisher": {
    "@type": "Organization",
    "name": "Online College Courses",
    "logo": {
      "@type": "ImageObject",
      "url": `${Astro.site}logo.png`
    }
  }
};

// Breadcrumb Schema
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": Astro.site?.href || "/"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Blog",
      "item": new URL("/blog", Astro.site).href
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": post.data.title,
      "item": Astro.url.href
    }
  ]
};

const pageTitle = `${post.data.title} | Blog`;
const pageDescription = post.data.description;
const readingTime = Math.ceil(post.body.split(' ').length / 200); // Approximate reading time
---

<Layout 
  title={pageTitle}
  description={pageDescription}
  image={post.data.image || '/og-image.jpg'}
>
  <!-- Schema.org Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />

  <main class="blog-post">
    <!-- Breadcrumb Navigation -->
    <div class="container">
      <nav class="breadcrumb" aria-label="Breadcrumb">
        <a href="/">Home</a>
        <span class="separator">/</span>
        <a href="/blog">Blog</a>
        <span class="separator">/</span>
        <span class="current">{post.data.title}</span>
      </nav>
    </div>

    <!-- Article Header -->
    <article class="article">
      <header class="article-header">
        <div class="container-narrow">
          {post.data.tags.length > 0 && (
            <div class="article-tags">
              {post.data.tags.map((tag) => (
                <span class="tag">{tag}</span>
              ))}
            </div>
          )}
          
          <h1 class="article-title">{post.data.title}</h1>
          
          <div class="article-meta">
            <div class="meta-left">
              <span class="author">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                  <circle cx="12" cy="7" r="4"/>
                </svg>
                {post.data.author}
              </span>
              <span class="divider">•</span>
              <time class="date" datetime={post.data.pubDate.toISOString()}>
                {post.data.pubDate.toLocaleDateString('en-US', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric'
                })}
              </time>
              <span class="divider">•</span>
              <span class="reading-time">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <polyline points="12 6 12 12 16 14"/>
                </svg>
                {readingTime} min read
              </span>
            </div>
            
            <div class="share-buttons">
              <button class="share-btn" data-share="twitter" aria-label="Share on Twitter">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
                </svg>
              </button>
              <button class="share-btn" data-share="facebook" aria-label="Share on Facebook">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/>
                </svg>
              </button>
              <button class="share-btn" data-share="linkedin" aria-label="Share on LinkedIn">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"/>
                  <rect x="2" y="9" width="4" height="12"/>
                  <circle cx="4" cy="4" r="2"/>
                </svg>
              </button>
            </div>
          </div>
        </div>

        {post.data.image && (
          <div class="featured-image">
            <img src={post.data.image} alt={post.data.title} />
          </div>
        )}
      </header>

      <!-- Article Content -->
      <div class="container-narrow">
        <div class="article-content">
          <Content />
        </div>

        <!-- Article Footer -->
        <footer class="article-footer">
          {post.data.updatedDate && (
            <p class="updated-notice">
              Last updated: {post.data.updatedDate.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
              })}
            </p>
          )}

          <div class="social-share">
            <p>Share this article:</p>
            <div class="share-buttons-footer">
              <button class="share-btn-footer" data-share="twitter">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
                </svg>
                Twitter
              </button>
              <button class="share-btn-footer" data-share="facebook">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/>
                </svg>
                Facebook
              </button>
              <button class="share-btn-footer" data-share="linkedin">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"/>
                  <rect x="2" y="9" width="4" height="12"/>
                  <circle cx="4" cy="4" r="2"/>
                </svg>
                LinkedIn
              </button>
            </div>
          </div>
        </footer>
      </div>
    </article>

    <!-- Related Posts -->
    {relatedPosts.length > 0 && (
      <section class="related-section">
        <div class="container">
          <h2>Related Articles</h2>
          <div class="related-grid">
            {relatedPosts.map((relatedPost) => (
              <a href={`/blog/${relatedPost.slug}`} class="related-card">
                {relatedPost.data.image && (
                  <div class="related-image">
                    <img src={relatedPost.data.image} alt={relatedPost.data.title} />
                  </div>
                )}
                <div class="related-content">
                  <h3>{relatedPost.data.title}</h3>
                  <p>{relatedPost.data.description}</p>
                  <span class="read-more-link">
                    Read More →
                  </span>
                </div>
              </a>
            ))}
          </div>
        </div>
      </section>
    )}

    <!-- CTA Section -->
    <section class="cta-section">
      <div class="container">
        <div class="cta-card">
          <h2>Ready to Start Learning?</h2>
          <p>Browse thousands of online courses from accredited institutions worldwide.</p>
          <a href="/" class="cta-button">Browse All Courses</a>
        </div>
      </div>
    </section>
  </main>
</Layout>

<style>
  .blog-post {
    background: white;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 calc(var(--spacing) * 3);
  }

  .container-narrow {
    max-width: 800px;
    margin: 0 auto;
    padding: 0 calc(var(--spacing) * 3);
  }

  /* Breadcrumb */
  .breadcrumb {
    padding: calc(var(--spacing) * 3) 0;
    display: flex;
    align-items: center;
    gap: calc(var(--spacing) * 1);
    font-size: 0.875rem;
    color: var(--neutral-600);
  }

  .breadcrumb a {
    color: var(--neutral-600);
    transition: var(--transition);
  }

  .breadcrumb a:hover {
    color: var(--color-primary);
  }

  .breadcrumb .separator {
    color: var(--neutral-400);
  }

  .breadcrumb .current {
    color: var(--neutral-900);
    font-weight: 500;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 300px;
  }

  /* Article Header */
  .article-header {
    margin-bottom: calc(var(--spacing) * 8);
  }

  .article-tags {
    display: flex;
    gap: calc(var(--spacing) * 1.5);
    margin-bottom: calc(var(--spacing) * 3);
    flex-wrap: wrap;
  }

  .tag {
    padding: calc(var(--spacing) * 0.75) calc(var(--spacing) * 2);
    background: var(--neutral-100);
    color: var(--neutral-700);
    font-size: 0.875rem;
    font-weight: 600;
    border-radius: calc(var(--border-radius) / 4);
    transition: var(--transition);
  }

  .tag:hover {
    background: var(--neutral-200);
  }

  .article-title {
    font-size: 3.5rem;
    line-height: 1.15;
    margin-bottom: calc(var(--spacing) * 3);
    color: var(--neutral-900);
  }

  .article-meta {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding-bottom: calc(var(--spacing) * 4);
    border-bottom: 2px solid var(--neutral-200);
    margin-bottom: calc(var(--spacing) * 4);
  }

  .meta-left {
    display: flex;
    align-items: center;
    gap: calc(var(--spacing) * 1.5);
    font-size: 0.9375rem;
    color: var(--neutral-600);
  }

  .author,
  .reading-time {
    display: flex;
    align-items: center;
    gap: calc(var(--spacing) * 0.75);
  }

  .divider {
    color: var(--neutral-400);
  }

  .share-buttons {
    display: flex;
    gap: calc(var(--spacing) * 1);
  }

  .share-btn {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--neutral-100);
    border: none;
    border-radius: calc(var(--border-radius) / 4);
    color: var(--neutral-600);
    cursor: pointer;
    transition: var(--transition);
  }

  .share-btn:hover {
    background: var(--color-primary);
    color: white;
    transform: translateY(-2px);
  }

  .featured-image {
    width: 100%;
    max-width: 1200px;
    margin: 0 auto calc(var(--spacing) * 6);
    border-radius: calc(var(--border-radius) * 1.5);
    overflow: hidden;
    box-shadow: var(--shadow-xl);
  }

  .featured-image img {
    width: 100%;
    height: auto;
    display: block;
  }

  /* Article Content */
  .article-content {
    font-size: 1.125rem;
    line-height: 1.8;
    color: var(--neutral-700);
    margin-bottom: calc(var(--spacing) * 8);
  }

  .article-content :global(h2) {
    font-size: 2rem;
    margin-top: calc(var(--spacing) * 6);
    margin-bottom: calc(var(--spacing) * 3);
    color: var(--neutral-900);
  }

  .article-content :global(h3) {
    font-size: 1.5rem;
    margin-top: calc(var(--spacing) * 5);
    margin-bottom: calc(var(--spacing) * 2);
    color: var(--neutral-900);
  }

  .article-content :global(h4) {
    font-size: 1.25rem;
    margin-top: calc(var(--spacing) * 4);
    margin-bottom: calc(var(--spacing) * 2);
    color: var(--neutral-900);
  }

  .article-content :global(p) {
    margin-bottom: calc(var(--spacing) * 3);
  }

  .article-content :global(ul),
  .article-content :global(ol) {
    margin-bottom: calc(var(--spacing) * 3);
    padding-left: calc(var(--spacing) * 4);
  }

  .article-content :global(li) {
    margin-bottom: calc(var(--spacing) * 1.5);
  }

  .article-content :global(a) {
    color: var(--color-primary);
    text-decoration: underline;
    font-weight: 500;
  }

  .article-content :global(a:hover) {
    color: var(--color-primary-dark);
  }

  .article-content :global(blockquote) {
    border-left: 4px solid var(--color-primary);
    padding-left: calc(var(--spacing) * 3);
    margin: calc(var(--spacing) * 4) 0;
    font-style: italic;
    color: var(--neutral-600);
    background: var(--neutral-50);
    padding: calc(var(--spacing) * 3);
    border-radius: calc(var(--border-radius) / 2);
  }

  .article-content :global(code) {
    background: var(--neutral-100);
    padding: calc(var(--spacing) * 0.5) calc(var(--spacing) * 1);
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
    color: var(--color-error);
  }

  .article-content :global(pre) {
    background: var(--neutral-900);
    color: var(--neutral-100);
    padding: calc(var(--spacing) * 3);
    border-radius: calc(var(--border-radius) / 2);
    overflow-x: auto;
    margin: calc(var(--spacing) * 4) 0;
  }

  .article-content :global(pre code) {
    background: none;
    padding: 0;
    color: inherit;
  }

  .article-content :global(img) {
    border-radius: calc(var(--border-radius));
    margin: calc(var(--spacing) * 4) 0;
    box-shadow: var(--shadow-md);
  }

  .article-content :global(hr) {
    border: none;
    border-top: 2px solid var(--neutral-200);
    margin: calc(var(--spacing) * 6) 0;
  }

  /* Article Footer */
  .article-footer {
    padding-top: calc(var(--spacing) * 6);
    border-top: 2px solid var(--neutral-200);
    margin-bottom: calc(var(--spacing) * 8);
  }

  .updated-notice {
    font-size: 0.9375rem;
    color: var(--neutral-600);
    font-style: italic;
    margin-bottom: calc(var(--spacing) * 4);
  }

  .social-share p {
    font-weight: 600;
    color: var(--neutral-700);
    margin-bottom: calc(var(--spacing) * 2);
  }

  .share-buttons-footer {
    display: flex;
    gap: calc(var(--spacing) * 2);
    flex-wrap: wrap;
  }

  .share-btn-footer {
    display: inline-flex;
    align-items: center;
    gap: calc(var(--spacing) * 1.5);
    padding: calc(var(--spacing) * 2) calc(var(--spacing) * 3);
    background: var(--neutral-100);
    border: none;
    border-radius: calc(var(--border-radius) / 2);
    color: var(--neutral-700);
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
  }

  .share-btn-footer:hover {
    background: var(--color-primary);
    color: white;
    transform: translateY(-2px);
  }

  /* Related Posts */
  .related-section {
    background: var(--neutral-50);
    padding: calc(var(--spacing) * 8) 0;
    margin-bottom: calc(var(--spacing) * 8);
  }

  .related-section h2 {
    font-size: 2rem;
    margin-bottom: calc(var(--spacing) * 4);
    color: var(--neutral-900);
  }

  .related-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: calc(var(--spacing) * 4);
  }

  .related-card {
    background: white;
    border-radius: calc(var(--border-radius) * 1.25);
    overflow: hidden;
    box-shadow: var(--shadow-md);
    transition: var(--transition);
    text-decoration: none;
    border: 1px solid var(--neutral-200);
  }

  .related-card:hover {
    box-shadow: var(--shadow-xl);
    transform: translateY(-4px);
  }

  .related-image {
    height: 180px;
    overflow: hidden;
    background: var(--neutral-200);
  }

  .related-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: var(--transition);
  }

  .related-card:hover .related-image img {
    transform: scale(1.05);
  }

  .related-content {
    padding: calc(var(--spacing) * 3);
  }

  .related-content h3 {
    font-size: 1.25rem;
    margin-bottom: calc(var(--spacing) * 2);
    color: var(--neutral-900);
  }

  .related-content p {
    font-size: 0.9375rem;
    line-height: 1.6;
    color: var(--neutral-600);
    margin-bottom: calc(var(--spacing) * 2);
  }

  .read-more-link {
    color: var(--color-primary);
    font-weight: 600;
    font-size: 0.9375rem;
  }

  /* CTA Section */
  .cta-section {
    padding: calc(var(--spacing) * 8) 0;
  }

  .cta-card {
    background: linear-gradient(135deg, #1e40af 0%, #0ea5e9 100%);
    padding: calc(var(--spacing) * 8);
    border-radius: calc(var(--border-radius) * 1.5);
    text-align: center;
    color: white;
  }

  .cta-card h2 {
    font-size: 2.5rem;
    margin-bottom: calc(var(--spacing) * 2);
    color: white;
  }

  .cta-card p {
    font-size: 1.125rem;
    margin-bottom: calc(var(--spacing) * 4);
    opacity: 0.95;
  }

  .cta-button {
    display: inline-flex;
    align-items: center;
    padding: calc(var(--spacing) * 2.5) calc(var(--spacing) * 5);
    background: white;
    color: var(--color-primary);
    font-weight: 700;
    font-size: 1.125rem;
    border-radius: calc(var(--border-radius) / 2);
    text-decoration: none;
    transition: var(--transition);
  }

  .cta-button:hover {
    background: var(--neutral-100);
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .article-title {
      font-size: 2.5rem;
    }

    .article-meta {
      flex-direction: column;
      align-items: flex-start;
      gap: calc(var(--spacing) * 2);
    }

    .meta-left {
      flex-wrap: wrap;
    }

    .article-content {
      font-size: 1.0625rem;
    }

    .related-grid {
      grid-template-columns: 1fr;
    }

    .cta-card h2 {
      font-size: 2rem;
    }
  }
</style>

<script>
  // Social sharing functionality
  const shareButtons = document.querySelectorAll('.share-btn, .share-btn-footer');
  
  shareButtons.forEach(button => {
    button.addEventListener('click', () => {
      const platform = button.getAttribute('data-share');
      const url = encodeURIComponent(window.location.href);
      const title = encodeURIComponent(document.title);
      
      let shareUrl = '';
      
      switch(platform) {
        case 'twitter':
          shareUrl = `https://twitter.com/intent/tweet?url=${url}&text=${title}`;
          break;
        case 'facebook':
          shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
          break;
        case 'linkedin':
          shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${url}`;
          break;
      }
      
      if (shareUrl) {
        window.open(shareUrl, '_blank', 'width=600,height=400');
      }
    });
  });
</script>
