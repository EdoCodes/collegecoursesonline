---
import Layout from '../../layouts/Layout.astro';
import CourseCard from '../../components/CourseCard.astro';
import { supabase, isSupabaseConfigured } from '../../lib/supabase';
import type { CourseCategory, Course } from '../../lib/supabase';

export async function getStaticPaths() {
  // Return empty array if Supabase not configured (allows build to complete)
  if (!isSupabaseConfigured || !supabase) {
    return [];
  }
  
  const { data: categories } = await supabase
    .from('course_categories')
    .select('slug');
  
  return categories?.map((category) => ({
    params: { slug: category.slug },
  })) || [];
}

const { slug } = Astro.params;

if (!isSupabaseConfigured || !supabase) {
  return Astro.redirect('/404');
}

const { data: category, error } = await supabase
  .from('course_categories')
  .select('*')
  .eq('slug', slug)
  .single();

if (error || !category) {
  return Astro.redirect('/404');
}

const typedCategory = category as CourseCategory;

// Get all courses in this category
const { data: courses } = await supabase
  .from('courses')
  .select(`
    *,
    colleges (*),
    course_categories (*)
  `)
  .eq('category_id', category.id)
  .order('featured', { ascending: false })
  .order('views_count', { ascending: false })
  .order('created_at', { ascending: false });

const coursesData = courses as Course[] || [];

// Calculate stats
const totalCourses = coursesData.length;
const freeCourses = coursesData.filter(c => c.price === 'Free').length;
const certificateCourses = coursesData.filter(c => c.certificate_available).length;

// Get unique colleges
const uniqueColleges = new Set(coursesData.map(c => c.colleges?.name).filter(Boolean));
const collegesCount = uniqueColleges.size;

// Breadcrumb Schema
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": Astro.site?.href || "/"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Categories",
      "item": new URL("/", Astro.site).href
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": category.name,
      "item": Astro.url.href
    }
  ]
};

// CollectionPage Schema
const collectionSchema = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": `${category.name} Online Courses`,
  "description": category.description || `Browse ${totalCourses} online ${category.name} courses from accredited institutions.`,
  "url": Astro.url.href
};

const pageTitle = `${category.name} Online Courses - ${totalCourses} Programs Available`;
const pageDescription = category.description || `Explore ${totalCourses} online ${category.name} courses from ${collegesCount} institutions. Find accredited programs, certificates, and degrees in ${category.name}.`;
---

<Layout 
  title={pageTitle}
  description={pageDescription}
  image={'/og-image.jpg'}
>
  <!-- Schema.org Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify(collectionSchema)} />
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />

  <main class="category-page">
    <!-- Breadcrumb Navigation -->
    <div class="container">
      <nav class="breadcrumb" aria-label="Breadcrumb">
        <a href="/">Home</a>
        <span class="separator">/</span>
        <a href="/">Categories</a>
        <span class="separator">/</span>
        <span class="current">{category.name}</span>
      </nav>
    </div>

    <!-- Category Hero Section -->
    <div class="hero-section">
      <div class="container">
        <div class="hero-content">
          <div class="category-icon-large">
            {category.icon || 'ðŸ“š'}
          </div>
          
          <h1 class="category-title">{category.name} Courses</h1>
          
          {category.description && (
            <p class="category-description">{category.description}</p>
          )}

          <!-- Stats Bar -->
          <div class="stats-bar">
            <div class="stat-item">
              <span class="stat-value">{totalCourses}</span>
              <span class="stat-label">Courses</span>
            </div>
            <div class="stat-divider"></div>
            <div class="stat-item">
              <span class="stat-value">{collegesCount}</span>
              <span class="stat-label">Institutions</span>
            </div>
            <div class="stat-divider"></div>
            <div class="stat-item">
              <span class="stat-value">{freeCourses}</span>
              <span class="stat-label">Free</span>
            </div>
            <div class="stat-divider"></div>
            <div class="stat-item">
              <span class="stat-value">{certificateCourses}</span>
              <span class="stat-label">With Certificates</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="container">
      <div class="content-layout">
        <!-- Main Content Area -->
        <div class="main-content">
          {coursesData.length > 0 ? (
            <>
              <!-- Filter Bar -->
              <div class="filter-bar">
                <div class="filter-info">
                  <span class="results-count">
                    Showing <strong id="courseCount">{coursesData.length}</strong> courses
                  </span>
                </div>
                
                <div class="filter-controls">
                  <select id="sortFilter" class="filter-select">
                    <option value="featured">Sort by: Featured</option>
                    <option value="popularity">Most Popular</option>
                    <option value="price-low">Price: Low to High</option>
                    <option value="price-high">Price: High to Low</option>
                    <option value="newest">Newest First</option>
                  </select>
                  
                  <select id="priceFilter" class="filter-select">
                    <option value="">All Prices</option>
                    <option value="free">Free Only</option>
                    <option value="paid">Paid Only</option>
                  </select>
                  
                  <select id="levelFilter" class="filter-select">
                    <option value="">All Levels</option>
                    <option value="Beginner">Beginner</option>
                    <option value="Intermediate">Intermediate</option>
                    <option value="Advanced">Advanced</option>
                  </select>
                  
                  <select id="certificateFilter" class="filter-select">
                    <option value="">All Courses</option>
                    <option value="certificate">Certificate Available</option>
                  </select>
                </div>
              </div>

              <!-- Courses Grid -->
              <div class="courses-grid" id="coursesGrid">
                {coursesData.map((course) => (
                  <div data-course-id={course.id} class="course-item">
                    <CourseCard course={course} />
                  </div>
                ))}
              </div>

              <!-- No Results Message (Hidden by default) -->
              <div id="noResults" class="no-results" style="display: none;">
                <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                  <circle cx="11" cy="11" r="8"/>
                  <path d="m21 21-4.35-4.35"/>
                </svg>
                <h3>No courses found</h3>
                <p>Try adjusting your filters</p>
              </div>
            </>
          ) : (
            <div class="no-courses">
              <svg width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
              </svg>
              <h3>No courses available yet</h3>
              <p>Check back later for {category.name} courses.</p>
              <a href="/" class="back-button">Browse All Courses</a>
            </div>
          )}
        </div>

        <!-- Sidebar -->
        <aside class="sidebar">
          <!-- Quick Guide Card -->
          <div class="info-card">
            <h3>Why Study {category.name}?</h3>
            <div class="benefits-list">
              <div class="benefit-item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
                <span>Learn from industry experts</span>
              </div>
              <div class="benefit-item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
                <span>Study at your own pace</span>
              </div>
              <div class="benefit-item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
                <span>Earn recognized certificates</span>
              </div>
              <div class="benefit-item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
                <span>Advance your career</span>
              </div>
            </div>
          </div>

          <!-- Stats Card -->
          <div class="info-card stats-card">
            <h3>Category Stats</h3>
            <div class="stats-list">
              <div class="stat-row">
                <span class="stat-label">Total Courses</span>
                <span class="stat-value-small">{totalCourses}</span>
              </div>
              <div class="stat-row">
                <span class="stat-label">Institutions</span>
                <span class="stat-value-small">{collegesCount}</span>
              </div>
              <div class="stat-row">
                <span class="stat-label">Free Courses</span>
                <span class="stat-value-small">{freeCourses}</span>
              </div>
              <div class="stat-row">
                <span class="stat-label">With Certificates</span>
                <span class="stat-value-small">{certificateCourses}</span>
              </div>
            </div>
          </div>

          <!-- Help Card -->
          <div class="info-card help-card">
            <h3>Need Help Choosing?</h3>
            <p>Not sure which course is right for you? Check out our blog for guides and tips on selecting the perfect online course.</p>
            <a href="/blog" class="help-link">Visit Our Blog</a>
          </div>
        </aside>
      </div>
    </div>

    <!-- Courses data for filtering -->
    <script type="application/json" id="coursesData" set:html={JSON.stringify(coursesData)} />
  </main>
</Layout>

<style>
  .category-page {
    min-height: 100vh;
  }

  .container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 calc(var(--spacing) * 3);
  }

  /* Breadcrumb */
  .breadcrumb {
    padding: calc(var(--spacing) * 3) 0;
    display: flex;
    align-items: center;
    gap: calc(var(--spacing) * 1);
    font-size: 0.875rem;
    color: var(--neutral-600);
  }

  .breadcrumb a {
    color: var(--neutral-600);
    transition: var(--transition);
  }

  .breadcrumb a:hover {
    color: var(--color-primary);
  }

  .breadcrumb .separator {
    color: var(--neutral-400);
  }

  .breadcrumb .current {
    color: var(--neutral-900);
    font-weight: 500;
  }

  /* Hero Section */
  .hero-section {
    background: linear-gradient(135deg, #1e40af 0%, #0ea5e9 100%);
    padding: calc(var(--spacing) * 8) 0;
    margin-bottom: calc(var(--spacing) * 6);
    text-align: center;
  }

  .hero-content {
    max-width: 900px;
    margin: 0 auto;
    color: white;
  }

  .category-icon-large {
    font-size: 5rem;
    margin-bottom: calc(var(--spacing) * 3);
  }

  .category-title {
    font-size: 3.5rem;
    margin-bottom: calc(var(--spacing) * 3);
    color: white;
  }

  .category-description {
    font-size: 1.25rem;
    line-height: 1.7;
    opacity: 0.95;
    margin-bottom: calc(var(--spacing) * 5);
    max-width: 700px;
    margin-left: auto;
    margin-right: auto;
  }

  .stats-bar {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: calc(var(--spacing) * 4);
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    padding: calc(var(--spacing) * 3);
    border-radius: calc(var(--border-radius));
  }

  .stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: calc(var(--spacing) * 0.5);
  }

  .stat-value {
    font-size: 2.5rem;
    font-weight: 800;
    line-height: 1;
  }

  .stat-label {
    font-size: 0.875rem;
    opacity: 0.9;
    font-weight: 500;
  }

  .stat-divider {
    width: 1px;
    height: 40px;
    background: rgba(255, 255, 255, 0.3);
  }

  /* Content Layout */
  .content-layout {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: calc(var(--spacing) * 6);
    margin-bottom: calc(var(--spacing) * 8);
  }

  .main-content {
    min-width: 0;
  }

  /* Filter Bar */
  .filter-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: calc(var(--spacing) * 3);
    padding: calc(var(--spacing) * 3);
    background: white;
    border-radius: calc(var(--border-radius));
    box-shadow: var(--shadow-md);
    margin-bottom: calc(var(--spacing) * 4);
    border: 1px solid var(--neutral-200);
    flex-wrap: wrap;
  }

  .filter-info {
    display: flex;
    align-items: center;
    gap: calc(var(--spacing) * 2);
  }

  .results-count {
    font-size: 1rem;
    color: var(--neutral-700);
  }

  .results-count strong {
    color: var(--color-primary);
    font-weight: 700;
  }

  .filter-controls {
    display: flex;
    gap: calc(var(--spacing) * 2);
    flex-wrap: wrap;
  }

  .filter-select {
    padding: calc(var(--spacing) * 1.5) calc(var(--spacing) * 2);
    border: 2px solid var(--neutral-200);
    border-radius: calc(var(--border-radius) / 2);
    font-size: 0.9375rem;
    color: var(--neutral-800);
    background: white;
    transition: var(--transition);
    cursor: pointer;
  }

  .filter-select:hover {
    border-color: var(--color-primary-light);
  }

  .filter-select:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
  }

  /* Courses Grid */
  .courses-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: calc(var(--spacing) * 3);
    margin-bottom: calc(var(--spacing) * 5);
  }

  .course-item {
    transition: var(--transition);
  }

  .no-results,
  .no-courses {
    text-align: center;
    padding: calc(var(--spacing) * 10) 0;
  }

  .no-results svg,
  .no-courses svg {
    margin: 0 auto calc(var(--spacing) * 3);
    color: var(--neutral-300);
  }

  .no-results h3,
  .no-courses h3 {
    font-size: 1.5rem;
    color: var(--neutral-700);
    margin-bottom: calc(var(--spacing) * 1);
  }

  .no-results p,
  .no-courses p {
    font-size: 1rem;
    color: var(--neutral-500);
    margin-bottom: calc(var(--spacing) * 3);
  }

  .back-button {
    display: inline-flex;
    align-items: center;
    gap: calc(var(--spacing) * 1.5);
    padding: calc(var(--spacing) * 2) calc(var(--spacing) * 3);
    background: var(--color-primary);
    color: white;
    font-weight: 600;
    border-radius: calc(var(--border-radius) / 2);
    text-decoration: none;
    transition: var(--transition);
  }

  .back-button:hover {
    background: var(--color-primary-dark);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }

  /* Sidebar */
  .sidebar {
    position: sticky;
    top: calc(var(--spacing) * 3);
    align-self: flex-start;
  }

  .info-card {
    background: white;
    border-radius: calc(var(--border-radius));
    padding: calc(var(--spacing) * 3);
    box-shadow: var(--shadow-md);
    margin-bottom: calc(var(--spacing) * 3);
    border: 1px solid var(--neutral-200);
  }

  .info-card h3 {
    font-size: 1.125rem;
    margin-bottom: calc(var(--spacing) * 2.5);
    color: var(--neutral-900);
  }

  .benefits-list {
    display: flex;
    flex-direction: column;
    gap: calc(var(--spacing) * 2);
  }

  .benefit-item {
    display: flex;
    align-items: flex-start;
    gap: calc(var(--spacing) * 1.5);
    color: var(--neutral-700);
    font-size: 0.9375rem;
  }

  .benefit-item svg {
    flex-shrink: 0;
    color: var(--color-success);
    margin-top: 2px;
  }

  .stats-card {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  }

  .stats-list {
    display: flex;
    flex-direction: column;
    gap: calc(var(--spacing) * 2);
  }

  .stat-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: calc(var(--spacing) * 2);
    border-bottom: 1px solid var(--neutral-200);
  }

  .stat-row:last-child {
    border-bottom: none;
    padding-bottom: 0;
  }

  .stat-label {
    font-size: 0.9375rem;
    color: var(--neutral-600);
    font-weight: 500;
  }

  .stat-value-small {
    font-size: 1.25rem;
    color: var(--neutral-900);
    font-weight: 700;
  }

  .help-card {
    background: linear-gradient(135deg, #1e40af 0%, #0ea5e9 100%);
    color: white;
  }

  .help-card h3 {
    color: white;
  }

  .help-card p {
    font-size: 0.9375rem;
    line-height: 1.6;
    margin-bottom: calc(var(--spacing) * 2.5);
    opacity: 0.95;
  }

  .help-link {
    display: inline-flex;
    align-items: center;
    padding: calc(var(--spacing) * 1.5) calc(var(--spacing) * 2.5);
    background: white;
    color: var(--color-primary);
    font-weight: 600;
    border-radius: calc(var(--border-radius) / 2);
    text-decoration: none;
    transition: var(--transition);
    font-size: 0.9375rem;
  }

  .help-link:hover {
    background: var(--neutral-100);
    transform: translateY(-2px);
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .content-layout {
      grid-template-columns: 1fr;
    }

    .sidebar {
      position: static;
    }
  }

  @media (max-width: 768px) {
    .category-title {
      font-size: 2.5rem;
    }

    .category-description {
      font-size: 1.125rem;
    }

    .stats-bar {
      flex-direction: column;
      gap: calc(var(--spacing) * 3);
    }

    .stat-divider {
      width: 60%;
      height: 1px;
    }

    .filter-bar {
      flex-direction: column;
      align-items: stretch;
    }

    .filter-controls {
      flex-direction: column;
    }

    .filter-select {
      width: 100%;
    }

    .courses-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  const coursesData = JSON.parse(document.getElementById('coursesData')?.textContent || '[]');
  let filteredCourses = [...coursesData];

  const coursesGrid = document.getElementById('coursesGrid');
  const noResults = document.getElementById('noResults');
  const courseCount = document.getElementById('courseCount');

  const sortFilter = document.getElementById('sortFilter') as HTMLSelectElement;
  const priceFilter = document.getElementById('priceFilter') as HTMLSelectElement;
  const levelFilter = document.getElementById('levelFilter') as HTMLSelectElement;
  const certificateFilter = document.getElementById('certificateFilter') as HTMLSelectElement;

  function filterAndSort() {
    filteredCourses = coursesData.filter((course: any) => {
      const matchesPrice = !priceFilter?.value ||
        (priceFilter.value === 'free' && course.price === 'Free') ||
        (priceFilter.value === 'paid' && course.price !== 'Free');

      const matchesLevel = !levelFilter?.value ||
        course.level === levelFilter.value;

      const matchesCertificate = !certificateFilter?.value ||
        course.certificate_available === true;

      return matchesPrice && matchesLevel && matchesCertificate;
    });

    // Sort
    const sortValue = sortFilter?.value || 'featured';
    filteredCourses.sort((a: any, b: any) => {
      switch (sortValue) {
        case 'popularity':
          return (b.views_count || 0) - (a.views_count || 0);
        case 'price-low':
          return (a.price_numeric || 0) - (b.price_numeric || 0);
        case 'price-high':
          return (b.price_numeric || 0) - (a.price_numeric || 0);
        case 'newest':
          return new Date(b.created_at).getTime() - new Date(a.created_at).getTime();
        case 'featured':
        default:
          if (b.featured !== a.featured) {
            return b.featured ? 1 : -1;
          }
          return new Date(b.created_at).getTime() - new Date(a.created_at).getTime();
      }
    });

    updateDisplay();
  }

  function updateDisplay() {
    if (courseCount) {
      courseCount.textContent = filteredCourses.length.toString();
    }

    if (filteredCourses.length === 0) {
      if (coursesGrid) coursesGrid.style.display = 'none';
      if (noResults) noResults.style.display = 'block';
    } else {
      if (coursesGrid) coursesGrid.style.display = 'grid';
      if (noResults) noResults.style.display = 'none';

      const courseItems = coursesGrid?.querySelectorAll('.course-item');
      courseItems?.forEach((item) => {
        const courseId = (item as HTMLElement).dataset.courseId;
        const shouldShow = filteredCourses.some((c: any) => c.id === courseId);
        (item as HTMLElement).style.display = shouldShow ? 'block' : 'none';
      });
    }
  }

  sortFilter?.addEventListener('change', filterAndSort);
  priceFilter?.addEventListener('change', filterAndSort);
  levelFilter?.addEventListener('change', filterAndSort);
  certificateFilter?.addEventListener('change', filterAndSort);
</script>
