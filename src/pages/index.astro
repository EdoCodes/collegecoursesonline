---
import Layout from '../layouts/Layout.astro';
import Hero from '../components/Hero.astro';
import CourseCard from '../components/CourseCard.astro';
import { supabase } from '../lib/supabase';
import type { Course } from '../lib/supabase';

const { data: courses, error } = await supabase
	.from('courses')
	.select(`
		*,
		colleges (*),
		course_categories (*)
	`)
	.order('featured', { ascending: false })
	.order('created_at', { ascending: false })
	.limit(50);

const coursesData: Course[] = courses || [];

const { data: categories } = await supabase
	.from('course_categories')
	.select('*')
	.order('name');
---

<Layout>
	<Hero />

	<main class="main-content">
		<div class="container">
			<section class="filters-section">
				<div class="filters-header">
					<h2>Browse Courses</h2>
					<div class="results-count" id="resultsCount">
						Showing <span id="courseCount">{coursesData.length}</span> courses
					</div>
				</div>

				<div class="search-box">
					<svg class="search-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
						<circle cx="9" cy="9" r="5" stroke="currentColor" stroke-width="2"/>
						<path d="M13 13L17 17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
					</svg>
					<input
						type="text"
						id="searchInput"
						placeholder="Search for courses (e.g., Algebra, Computer Science)..."
						class="search-input"
					/>
				</div>

				<div class="filters">
					<div class="filter-group">
						<label for="categoryFilter">Subject</label>
						<select id="categoryFilter" class="filter-select">
							<option value="">All Subjects</option>
							{categories?.map(cat => (
								<option value={cat.slug}>{cat.icon} {cat.name}</option>
							))}
						</select>
					</div>

					<div class="filter-group">
						<label for="sortFilter">Sort By</label>
						<select id="sortFilter" class="filter-select">
							<option value="featured">Featured</option>
							<option value="popularity">Popularity</option>
							<option value="price-low">Price: Low to High</option>
							<option value="price-high">Price: High to Low</option>
							<option value="ease">Ease of Access</option>
							<option value="accreditation">Accreditation</option>
						</select>
					</div>

					<div class="filter-group">
						<label for="levelFilter">Level</label>
						<select id="levelFilter" class="filter-select">
							<option value="">All Levels</option>
							<option value="Beginner">Beginner</option>
							<option value="Intermediate">Intermediate</option>
							<option value="Advanced">Advanced</option>
						</select>
					</div>

					<div class="filter-group">
						<label for="priceFilter">Price</label>
						<select id="priceFilter" class="filter-select">
							<option value="">All Prices</option>
							<option value="Free">Free Only</option>
							<option value="Paid">Paid</option>
						</select>
					</div>

					<div class="filter-group">
						<label for="certificateFilter">Certificate</label>
						<select id="certificateFilter" class="filter-select">
							<option value="">All</option>
							<option value="true">Certificate Available</option>
						</select>
					</div>

					<div class="filter-group">
						<label for="accreditationFilter">Accreditation</label>
						<select id="accreditationFilter" class="filter-select">
							<option value="">All Types</option>
							<option value="Regional">Regional</option>
							<option value="National">National</option>
							<option value="International">International</option>
						</select>
					</div>
				</div>
			</section>

			<section class="courses-section">
				<div class="courses-grid" id="coursesGrid">
					{coursesData.map(course => (
						<CourseCard course={course} />
					))}
				</div>

				<div class="no-results" id="noResults" style="display: none;">
					<svg width="120" height="120" viewBox="0 0 120 120" fill="none">
						<circle cx="60" cy="60" r="50" fill="#f5f5f5"/>
						<path d="M45 50C45 47.2386 47.2386 45 50 45H70C72.7614 45 75 47.2386 75 50V70C75 72.7614 72.7614 75 70 75H50C47.2386 75 45 72.7614 45 70V50Z" stroke="#a3a3a3" stroke-width="3"/>
						<circle cx="55" cy="57" r="3" fill="#a3a3a3"/>
						<circle cx="65" cy="57" r="3" fill="#a3a3a3"/>
						<path d="M52 67C52 67 56 63 60 63C64 63 68 67 68 67" stroke="#a3a3a3" stroke-width="3" stroke-linecap="round"/>
					</svg>
					<h3>No courses found</h3>
					<p>Try adjusting your filters or search terms</p>
				</div>
			</section>
		</div>
	</main>

	<script type="application/ld+json" set:html={JSON.stringify({
		"@context": "https://schema.org",
		"@type": "EducationalOrganization",
		"name": "Online College Courses",
		"description": "Directory of online college courses from accredited institutions",
		"url": "https://onlinecourses.edu",
		"offers": coursesData.slice(0, 10).map(course => ({
			"@type": "Course",
			"name": course.title,
			"description": course.description,
			"provider": {
				"@type": "Organization",
				"name": course.colleges?.name
			}
		}))
	})} />
</Layout>

<style>
	.main-content {
		padding: calc(var(--spacing) * 8) 0;
		min-height: 60vh;
	}

	.container {
		max-width: 1400px;
		margin: 0 auto;
		padding: 0 calc(var(--spacing) * 3);
	}

	.filters-section {
		margin-bottom: calc(var(--spacing) * 5);
	}

	.search-box {
		position: relative;
		margin-bottom: calc(var(--spacing) * 3);
	}

	.search-icon {
		position: absolute;
		left: calc(var(--spacing) * 2);
		top: 50%;
		transform: translateY(-50%);
		color: var(--neutral-400);
		pointer-events: none;
	}

	.search-input {
		width: 100%;
		padding: calc(var(--spacing) * 2) calc(var(--spacing) * 2) calc(var(--spacing) * 2) calc(var(--spacing) * 6);
		border: 2px solid var(--neutral-200);
		border-radius: var(--border-radius);
		font-size: 1.125rem;
		color: var(--neutral-800);
		background: white;
		transition: var(--transition);
		box-shadow: var(--shadow-sm);
	}

	.search-input:hover {
		border-color: var(--neutral-300);
	}

	.search-input:focus {
		outline: none;
		border-color: var(--color-primary);
		box-shadow: 0 0 0 4px rgba(0, 102, 204, 0.1);
	}

	.search-input::placeholder {
		color: var(--neutral-400);
	}

	.filters-header {
		display: flex;
		align-items: center;
		justify-content: space-between;
		margin-bottom: calc(var(--spacing) * 3);
		flex-wrap: wrap;
		gap: calc(var(--spacing) * 2);
	}

	.filters-header h2 {
		font-size: 2rem;
		color: var(--neutral-900);
	}

	.results-count {
		font-size: 1rem;
		color: var(--neutral-600);
	}

	#courseCount {
		font-weight: 600;
		color: var(--color-primary);
	}

	.filters {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
		gap: calc(var(--spacing) * 2);
		padding: calc(var(--spacing) * 3);
		background: white;
		border-radius: var(--border-radius);
		box-shadow: var(--shadow-sm);
	}

	.filter-group label {
		display: block;
		font-size: 0.875rem;
		font-weight: 600;
		color: var(--neutral-700);
		margin-bottom: calc(var(--spacing) * 1);
	}

	.filter-select {
		width: 100%;
		padding: calc(var(--spacing) * 1.5);
		border: 2px solid var(--neutral-200);
		border-radius: calc(var(--border-radius) / 2);
		font-size: 1rem;
		color: var(--neutral-800);
		background: white;
		transition: var(--transition);
		cursor: pointer;
	}

	.filter-select:hover {
		border-color: var(--neutral-300);
	}

	.filter-select:focus {
		outline: none;
		border-color: var(--color-primary);
		box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
	}

	.courses-section {
		position: relative;
	}

	.courses-grid {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
		gap: calc(var(--spacing) * 3);
		margin-bottom: calc(var(--spacing) * 5);
	}

	.no-results {
		text-align: center;
		padding: calc(var(--spacing) * 10) 0;
	}

	.no-results svg {
		margin: 0 auto calc(var(--spacing) * 3);
	}

	.no-results h3 {
		font-size: 1.5rem;
		color: var(--neutral-700);
		margin-bottom: calc(var(--spacing) * 1);
	}

	.no-results p {
		font-size: 1rem;
		color: var(--neutral-500);
	}

	@media (max-width: 768px) {
		.main-content {
			padding: calc(var(--spacing) * 5) 0;
		}

		.filters-header h2 {
			font-size: 1.5rem;
		}

		.filters {
			grid-template-columns: 1fr;
		}

		.courses-grid {
			grid-template-columns: 1fr;
		}
	}
</style>

<script>
	const coursesData = JSON.parse(document.getElementById('coursesData')?.textContent || '[]');
	let filteredCourses = [...coursesData];

	const coursesGrid = document.getElementById('coursesGrid');
	const noResults = document.getElementById('noResults');
	const courseCount = document.getElementById('courseCount');

	const searchInput = document.getElementById('searchInput') as HTMLInputElement;
	const categoryFilter = document.getElementById('categoryFilter') as HTMLSelectElement;
	const sortFilter = document.getElementById('sortFilter') as HTMLSelectElement;
	const levelFilter = document.getElementById('levelFilter') as HTMLSelectElement;
	const priceFilter = document.getElementById('priceFilter') as HTMLSelectElement;
	const certificateFilter = document.getElementById('certificateFilter') as HTMLSelectElement;
	const accreditationFilter = document.getElementById('accreditationFilter') as HTMLSelectElement;

	let searchQuery = '';

	function filterAndSortCourses() {
		filteredCourses = coursesData.filter((course: any) => {
			const matchesSearch = searchQuery === '' ||
				course.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
				course.description.toLowerCase().includes(searchQuery.toLowerCase()) ||
				course.colleges?.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
				course.course_categories?.name.toLowerCase().includes(searchQuery.toLowerCase());

			const matchesCategory = !categoryFilter?.value ||
				course.course_categories?.slug === categoryFilter.value;

			const matchesLevel = !levelFilter?.value ||
				course.level === levelFilter.value;

			const matchesPrice = !priceFilter?.value ||
				(priceFilter.value === 'Free' && course.price === 'Free') ||
				(priceFilter.value === 'Paid' && course.price !== 'Free');

			const matchesCertificate = !certificateFilter?.value ||
				course.certificate_available === true;

			const matchesAccreditation = !accreditationFilter?.value ||
				course.colleges?.accreditation_level === accreditationFilter.value;

			return matchesSearch && matchesCategory && matchesLevel && matchesPrice && matchesCertificate && matchesAccreditation;
		});

		const sortValue = sortFilter?.value || 'featured';
		filteredCourses.sort((a: any, b: any) => {
			switch (sortValue) {
				case 'popularity':
					return (b.colleges?.popularity_score || 0) - (a.colleges?.popularity_score || 0);
				case 'price-low':
					return (a.price_numeric || 0) - (b.price_numeric || 0);
				case 'price-high':
					return (b.price_numeric || 0) - (a.price_numeric || 0);
				case 'ease':
					return (b.colleges?.ease_of_access_score || 0) - (a.colleges?.ease_of_access_score || 0);
				case 'accreditation':
					const accreditationOrder: any = { 'Regional': 3, 'National': 2, 'International': 1 };
					return (accreditationOrder[b.colleges?.accreditation_level] || 0) -
					       (accreditationOrder[a.colleges?.accreditation_level] || 0);
				case 'featured':
				default:
					if (b.featured !== a.featured) {
						return b.featured ? 1 : -1;
					}
					return new Date(b.created_at).getTime() - new Date(a.created_at).getTime();
			}
		});

		updateDisplay();
	}

	function updateDisplay() {
		if (courseCount) {
			courseCount.textContent = filteredCourses.length.toString();
		}

		if (filteredCourses.length === 0) {
			if (coursesGrid) coursesGrid.style.display = 'none';
			if (noResults) noResults.style.display = 'block';
		} else {
			if (coursesGrid) coursesGrid.style.display = 'grid';
			if (noResults) noResults.style.display = 'none';

			const cards = coursesGrid?.querySelectorAll('.course-card');
			cards?.forEach((card, index) => {
				const courseId = (card as HTMLElement).dataset.courseId;
				const shouldShow = filteredCourses.some((c: any) => c.id === courseId);
				(card as HTMLElement).style.display = shouldShow ? 'flex' : 'none';
			});
		}
	}

	searchInput?.addEventListener('input', (e) => {
		searchQuery = (e.target as HTMLInputElement).value;
		filterAndSortCourses();
	});

	categoryFilter?.addEventListener('change', filterAndSortCourses);
	sortFilter?.addEventListener('change', filterAndSortCourses);
	levelFilter?.addEventListener('change', filterAndSortCourses);
	priceFilter?.addEventListener('change', filterAndSortCourses);
	certificateFilter?.addEventListener('change', filterAndSortCourses);
	accreditationFilter?.addEventListener('change', filterAndSortCourses);
</script>

<script id="coursesData" type="application/json" set:html={JSON.stringify(coursesData)} />

<style is:global>
	.course-card {
		animation: fadeIn 0.5s ease-out;
	}

	@keyframes fadeIn {
		from {
			opacity: 0;
			transform: translateY(20px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}
</style>
